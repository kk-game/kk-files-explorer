<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>æ–‡ä»¶ç®¡ç†å™¨</title>
    <link rel="stylesheet" type="text/css" href="./static/style.css"/>
</head>

<body>
<div class="container">
    <h2>ğŸ“‚ kk-file-explorer</h2>

    <!-- æ·»åŠ ç§˜é’¥è¾“å…¥æ¡† -->
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
        <span style="font-size: 16px; color: #333;">å¡«å†™ç§˜é’¥:</span>
        <label id="secret-key"><input type="text" style="" placeholder="è¯·è¾“å…¥ç§˜é’¥"></label>
        <button onclick="saveSecretKey()"
                style="padding: 8px 12px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">
            å¡«å†™
        </button>
    </div>

    <div class="nav-buttons">
        <button onclick="goUp()">è¿”å›ä¸Šä¸€çº§</button>
        <span id="current-path">å½“å‰è·¯å¾„ï¼š/</span>
    </div>

    <ul id="file-list"></ul>
    <button id="clean-btn">æ¸…ç©ºæ–‡ä»¶</button>
    <div id="drop-area">ğŸ“¥ æ‹–æ‹½æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹åˆ°è¿™é‡Œ</div>
    <ul id="upload-list"></ul>
    <button id="upload-btn">â¬†ï¸ å¼€å§‹ä¸Šä¼ </button>
    <div id="progress">
        <div id="progress-bar"></div>
    </div>
    <div id="upload-status">âœ… ä¸Šä¼ å®Œæˆï¼</div>
</div>
<script>
    let currentDir = "";

    function showFileSize(size) {
        if (size < 1024) {
            return size + " b"
        }
        if (size < 1024 * 1024) {
            return (size / 1024).toFixed(2) + " KB"
        }
        if (size < 1024 * 1024 * 1024) {
            return (size / 1024 / 1024).toFixed(2) + " MB"
        }
        if (size < 1024 * 1024 * 1024 * 1024) {
            return (size / 1024 / 1024 / 1024).toFixed(2) + " GB"
        }

        return (size / 1024 / 1024 / 1024 / 1024).toFixed(2) + " TB"
    }

    // æ›´æ–°å½“å‰è·¯å¾„çš„æ˜¾ç¤º
    function updatePathDisplay() {
        const pathDisplay = document.getElementById("current-path");
        pathDisplay.textContent = "å½“å‰è·¯å¾„ï¼š" + (currentDir === "" ? "/" : currentDir + "/");
    }

    // åˆ é™¤æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹
    function deleteFileOrFolder(fileName, type) {
        const secretKey = localStorage.getItem("secretKey");
        if (!secretKey) {
            alert("ç§˜é’¥æœªå¡«å†™æˆ–æ— æ•ˆï¼");
            return;
        }

        if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${fileName} å—ï¼Ÿ`)) return;

        fetch(`/delete`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                path: currentDir + "/" + fileName,
                type: type, // ä¼ é€’æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹ç±»å‹
                secretKey: secretKey // ä¼ é€’ç§˜é’¥
            })
        }).then(res => res.json())
            .then(data => {
                if (data.code === 0) {
                    console.log("åˆ é™¤æˆåŠŸ!")
                    fetchFiles(); // é‡æ–°åŠ è½½æ–‡ä»¶åˆ—è¡¨
                } else {
                    alert("åˆ é™¤å¤±è´¥: " + data.info);
                }
            }).catch(err => console.error("åˆ é™¤å¤±è´¥", err));
    }

    function fetchFiles() {
        fetch(`/files?dir=${currentDir}`)
            .then(res => res.json())
            .then(data => {
                let fileList = document.getElementById("file-list");
                fileList.innerHTML = "";
                if (!data || data.length < 1) {
                    return;
                }

                updatePathDisplay();

                let listDire = [];
                let listFiles = [];
                data.forEach(file => {
                    if (file.type === "file") {
                        listFiles.push(file);
                    } else {
                        listDire.push(file);
                    }
                });

                if (listFiles.length > 0) {
                    listDire.push(...listFiles);
                }

                listDire.forEach(file => {
                    let li = document.createElement("li");
                    let fileName = document.createElement("span");
                    if (file.type === "file") {
                        fileName.innerHTML = `ğŸ“„${file.name} <a style="background-color: #555555;border-radius: 5px;padding: 5px;color: #ffffff;">${showFileSize(Number(file.size))} </a>`;
                        fileName.onclick = () => {
                            let curFilePath = currentDir + "/" + file.name;
                            console.log(curFilePath);
                        }

                    } else {
                        fileName.innerHTML = `ğŸ“‚ ${file.name}/`;
                        fileName.style.color = "#095af1";
                        fileName.style.cursor = "pointer";
                        fileName.onclick = () => {
                            currentDir += "/" + file.name;
                            console.log(currentDir);
                            updatePathDisplay()
                            fetchFiles();
                        };
                    }

                    let deleteBtn = document.createElement("button");
                    deleteBtn.textContent = " åˆ é™¤ ";
                    deleteBtn.classList.add("delete-btn");
                    deleteBtn.onclick = () => deleteFileOrFolder(file.name, file.type);

                    li.appendChild(fileName);
                    li.appendChild(deleteBtn);
                    fileList.appendChild(li);
                });
            });
    }

    function goUp() {
        let parts = currentDir.split("/");
        if (parts.length <= 1) {
            alert("å·²ç»æ˜¯æ ¹ç›®å½•ï¼");
            return;
        }
        parts.pop();
        currentDir = parts.join("/");
        fetchFiles();
    }

    let uploadList = [];
    const dropArea = document.getElementById("drop-area");

    ["dragenter", "dragover"].forEach(eventName => {
        dropArea.addEventListener(eventName, e => {
            e.preventDefault();
            dropArea.style.borderColor = "black";
        });
    });

    ["dragleave", "drop"].forEach(eventName => {
        dropArea.addEventListener(eventName, () => {
            dropArea.style.borderColor = "#009688";
        });
    });

    dropArea.addEventListener("drop", (e) => {
        e.preventDefault();
        let items = e.dataTransfer.items;
        for (let i = 0; i < items.length; i++) {
            // å°è¯•è·å– FileSystemEntry å¯¹è±¡ï¼ˆä»… Chrome åŠéƒ¨åˆ†æ”¯æŒ webkit å‰ç¼€çš„æµè§ˆå™¨ï¼‰
            let entry = items[i].webkitGetAsEntry();
            if (entry) {
                traverseFileTree(entry);
            }
        }
        updateUploadList();
    });

    // é€’å½’è¯»å–æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹ä¸­çš„å­æ–‡ä»¶
    function traverseFileTree(item, path = "") {
        if (item.isFile) {
            // è¯»å–æ–‡ä»¶å¯¹è±¡ï¼Œå¹¶å°†å…¶åŠ å…¥ uploadList
            item.file((file) => {
                // å¯é€‰ï¼šä¸º file å¢åŠ å±æ€§ï¼Œä¿å­˜å®Œæ•´è·¯å¾„
                file.fullPath = path + file.name;
                uploadList.push(file);
                updateUploadList();
                console.log(file.fullPath)
            });
        } else if (item.isDirectory) {
            // å¦‚æœæ˜¯æ–‡ä»¶å¤¹ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªç›®å½•è¯»å–å™¨
            let dirReader = item.createReader();
            // è¯»å–ç›®å½•ä¸‹çš„æ‰€æœ‰æ¡ç›®ï¼ˆæ–‡ä»¶æˆ–å­æ–‡ä»¶å¤¹ï¼‰
            dirReader.readEntries((entries) => {
                for (let i = 0; i < entries.length; i++) {
                    // é€’å½’è°ƒç”¨ï¼Œæ³¨æ„è·¯å¾„ç´¯åŠ 
                    traverseFileTree(entries[i], path + item.name + "/");
                }
            });
        }
    }

    function updateUploadList() {
        let ul = document.getElementById("upload-list");
        ul.innerHTML = "";
        uploadList.forEach((file, index) => {
            let li = document.createElement("li");
            li.textContent = file.fullPath;
            let btn = document.createElement("button");
            btn.textContent = showFileSize(file.size) + " åˆ é™¤";
            btn.classList.add("delete-btn");
            btn.onclick = () => {
                uploadList.splice(index, 1);
                updateUploadList();
            };
            li.appendChild(btn);
            ul.appendChild(li);

            //ç½‘é¡µæ»šåŠ¨åˆ°åº•
            window.scrollTo({
                top: document.body.scrollHeight,
                behavior: "smooth" // å¯é€‰ï¼Œå¹³æ»‘æ»šåŠ¨æ•ˆæœ
            });
        });
    }

    document.getElementById("clean-btn").onclick = () => {
        uploadList = [];
        updateUploadList();
    };

    // è¯»å–æœ¬åœ°å­˜å‚¨çš„ç§˜é’¥å¹¶å¡«å……åˆ°è¾“å…¥æ¡†
    function loadSecretKey() {
        const secretKey = localStorage.getItem("secretKey");
        if (secretKey) {
            document.getElementById("secret-key").value = secretKey;
        }
    }

    // ä¿å­˜ç§˜é’¥åˆ°æœ¬åœ°å­˜å‚¨
    function saveSecretKey() {
        const secretKey = document.getElementById("secret-key").value;
        if (secretKey.indexOf("å¡«å†™æˆåŠŸ") >= 0) {
            return;
        }
        localStorage.setItem("secretKey", secretKey);
        document.getElementById("secret-key").value = secretKey + "  å¡«å†™æˆåŠŸ"
    }

    document.getElementById("upload-btn").onclick = () => {
        const secretKey = localStorage.getItem("secretKey");
        if (!secretKey) {
            alert("ç§˜é’¥æœªå¡«å†™æˆ–æ— æ•ˆï¼");
            return;
        }

        if (!uploadList || uploadList.length < 1) {
            document.getElementById("upload-status").style.display = "none";
            document.getElementById("progress").style.display = "none";
            console.log("æ²¡æœ‰ä¸Šä¼ æ–‡ä»¶");
            return;
        }

        let formData = new FormData();
        uploadList.forEach(file => {
            formData.append("files", file);
            formData.append("paths", file.fullPath); // å‘é€æ–‡ä»¶çš„ç›¸å¯¹è·¯å¾„
        });
        formData.append("secretKey", secretKey); // ä¼ é€’ç§˜é’¥

        let xhr = new XMLHttpRequest();
        xhr.open("POST", `/upload?dir=${currentDir}`, true);

        xhr.upload.onprogress = (e) => {
            if (e.lengthComputable) {
                let percent = (e.loaded / e.total) * 100;
                document.getElementById("progress").style.display = "block";
                document.getElementById("progress-bar").style.width = percent + "%";
            }
        };

        xhr.onload = () => {
            if (xhr.status !== 200) {
                return
            }

            let jsonData;
            try {
                jsonData = JSON.parse(xhr.responseText);
                if (jsonData.code !== 0) {
                    console.log(jsonData.info)
                    return
                }
            } catch (err) {
                console.log(err);
                return
            }


            document.getElementById("upload-status").style.display = "block";
            uploadList = [];
            updateUploadList();
            fetchFiles();
        };

        xhr.send(formData);
    };

    // é¡µé¢åŠ è½½æ—¶åŠ è½½ç§˜é’¥
    loadSecretKey();
    fetchFiles();
</script>
</body>

</html>